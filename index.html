<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion de Projets - Google Sheets</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        }
        .login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
        .login-box {
            width:100%; max-width:420px; background:#fff; border-radius:12px; padding:32px;
            box-shadow:0 10px 40px rgba(0,0,0,0.25);
        }
        .btn-login { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border:none; color:#fff; }
        .app-container { display:none; min-height:100vh; }
        .sidebar {
            position:fixed; left:0; top:0; width:250px; min-height:100vh;
            background: linear-gradient(180deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px 10px; overflow:auto;
        }
        .main-content { margin-left:250px; padding:30px; }
        .view-section { display:none; }
        .view-section.active { display:block; }
        .task-card { background:#fff; border-left:4px solid #667eea; padding:12px; border-radius:8px; margin-bottom:12px; }
        .badge-priority { font-size:0.85rem; padding:5px 8px; border-radius:6px; color:#fff; }
        .loading { display:none; text-align:center; padding:20px; }
        .loading.active { display:block; }
        .sync-status { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1000;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .sync-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .sync-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .sync-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        @media (max-width:768px) {
            .sidebar { width:200px; }
            .main-content { margin-left:200px; padding:18px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2><i class="bi bi-shield-lock"></i> Authentification</h2>
            <p>Connectez-vous à votre espace de gestion de projets</p>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input id="email" type="email" class="form-control" placeholder="votre@email.com" required>
                </div>
                <div class="mb-3">
                    <label for="code" class="form-label">Code d'accès</label>
                    <input id="code" type="password" class="form-control" placeholder="Entrez votre code" required>
                </div>
                <button type="submit" class="btn btn-login w-100">
                    <i class="bi bi-box-arrow-in-right"></i> Se connecter
                </button>
            </form>

            <div class="setup-info mt-3 p-3" style="background:#f0f4ff;border-left:4px solid #667eea;">
                <strong>Identifiants de test:</strong>
                <p style="margin:8px 0 0 0;">Email: <code>admin@example.com</code><br>Code: <code>1234</code></p>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="appContainer" class="app-container">
        <div class="sidebar">
            <div class="sidebar-header text-center mb-3">
                <h3>GestioProj</h3>
                <p style="opacity:0.9; margin:0;">Gestion de Projets</p>
            </div>
            <nav class="nav flex-column">
                <a class="nav-link active text-white" href="#" data-view="dashboard"><i class="bi bi-speedometer2"></i> Tableau de bord</a>
                <a class="nav-link text-white" href="#" data-view="projects"><i class="bi bi-folder"></i> Projets</a>
                <a class="nav-link text-white" href="#" data-view="tasks"><i class="bi bi-list-task"></i> Tâches</a>
                <a class="nav-link text-white" href="#" data-view="members"><i class="bi bi-people"></i> Membres</a>
                <a class="nav-link text-white" href="#" data-view="admin"><i class="bi bi-gear"></i> Administration</a>
                <hr style="opacity:0.3;">
                <a class="nav-link text-white" href="#" id="syncBtn"><i class="bi bi-arrow-repeat"></i> Synchroniser</a>
                <a class="nav-link text-white" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Déconnexion</a>
            </nav>
        </div>

        <div class="main-content">
            <div class="header-bar bg-white p-3 rounded mb-3 d-flex justify-content-between align-items-center" style="box-shadow:0 2px 10px rgba(0,0,0,0.08);">
                <h1 id="viewTitle" style="color:#667eea; font-size:1.5rem; margin:0;">Tableau de bord</h1>
                <div class="d-flex align-items-center">
                    <div id="lastSync" class="text-muted me-3" style="font-size:0.9rem;">
                        Dernière synchro: <span id="lastSyncTime">Jamais</span>
                    </div>
                    <div class="user-info text-end" style="color:#666;">
                        <p style="margin:0;"><strong id="userName">Utilisateur</strong></p>
                        <p id="userRole" style="margin:0;">Rôle</p>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div>
                <p class="mt-2">Chargement des données...</p>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard" class="view-section active">
                <div class="row mb-3">
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="projectCount" style="color:#667eea;">0</h3>
                            <p>Projets accessibles</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="taskCount" style="color:#764ba2;">0</h3>
                            <p>Tâches assignées</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="completedCount" style="color:#28a745;">0</h3>
                            <p>Tâches terminées</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="lateCount" style="color:#dc3545;">0</h3>
                            <p>Tâches en retard</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-gradient" style="background:linear-gradient(135deg,#667eea,#764ba2); color:#fff;">
                        <h5 class="mb-0">Tâches récentes</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentTasks"></div>
                    </div>
                </div>
            </div>

            <!-- PROJECTS -->
            <div id="projects" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Projets</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projectModal">
                        <i class="bi bi-plus-circle"></i> Nouveau projet
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Description</th>
                                    <th>Dates</th>
                                    <th>Responsable</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TASKS -->
            <div id="tasks" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Tâches</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="bi bi-plus-circle"></i> Nouvelle tâche
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4 mb-2">
                        <select id="projectFilter" class="form-select"><option value="">Tous les projets</option></select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <select id="statusFilter" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option>À faire</option>
                            <option>En cours</option>
                            <option>Terminé</option>
                        </select>
                    </div>
                </div>

                <div id="tasksList"></div>
            </div>

            <!-- MEMBERS -->
            <div id="members" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Membres</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#memberModal">
                        <i class="bi bi-plus-circle"></i> Nouveau membre
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Projets</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="admin" class="view-section">
                <h2>Administration</h2>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">Gestion des utilisateurs</div>
                            <div class="card-body">
                                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userModal">
                                    <i class="bi bi-person-plus"></i> Ajouter un utilisateur
                                </button>
                                <div id="usersList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">Informations système</div>
                            <div class="card-body">
                                <p><strong>Utilisateurs:</strong> <span id="usersCount">0</span></p>
                                <p><strong>Membres:</strong> <span id="membersCount">0</span></p>
                                <p><strong>Projets:</strong> <span id="projectsCount">0</span></p>
                                <p><strong>Tâches:</strong> <span id="tasksCount">0</span></p>
                                <p><strong>Dernière synchro:</strong> <span id="adminSyncTime">Jamais</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALS -->
    <!-- Project Modal -->
    <div class="modal fade" id="projectModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau projet</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="projectForm">
                <div class="mb-3"><label class="form-label">Nom du projet *</label><input id="projectName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea id="projectDesc" class="form-control" rows="3"></textarea></div>
                <div class="mb-3"><label class="form-label">Date de début *</label><input id="projectStart" type="date" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Date de fin *</label><input id="projectEnd" type="date" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Responsable *</label><select id="projectManager" class="form-select" required><option value="">Sélectionner un membre</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveProjectBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouvelle tâche</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="mb-3"><label class="form-label">Nom de la tâche *</label><input id="taskName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea id="taskDescription" class="form-control" rows="3"></textarea></div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Projet *</label><select id="taskProject" class="form-select" required><option value="">Sélectionner un projet</option></select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Assigné à *</label><select id="taskAssignee" class="form-select" required><option value="">Sélectionner un membre</option></select></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Date de début *</label><input id="taskStart" type="date" class="form-control" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Date de fin *</label><input id="taskEnd" type="date" class="form-control" required></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Statut</label><select id="taskStatus" class="form-select"><option>À faire</option><option>En cours</option><option>Terminé</option></select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Priorité</label><select id="taskPriority" class="form-select"><option>Basse</option><option selected>Moyenne</option><option>Haute</option></select></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveTaskBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- Member Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau membre</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="memberForm">
                <div class="mb-3"><label class="form-label">Nom *</label><input id="memberName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Email *</label><input id="memberEmail" type="email" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Rôle *</label><select id="memberRole" class="form-select" required><option value="">Sélectionner</option><option>Développeur</option><option>Designer</option><option>Manager</option><option>QA</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveMemberBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Ajouter un utilisateur système</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="userForm">
                <div class="mb-3"><label class="form-label">Email *</label><input id="userEmail" type="email" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Code d'accès *</label><input id="userCode" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Rôle *</label><select id="userRole" class="form-select" required><option>Utilisateur</option><option>Responsable Projet</option><option>Administrateur</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveUserBtn">Enregistrer</button></div>
    </div></div></div>

    <script>
    /*****************************************************************
     * CONFIGURATION
     *****************************************************************/
    const AUTH_API_URL = 'https://script.google.com/macros/s/AKfycbybESlz7o1UL0NZHM6zCO0SdZWw8o3RrQxF1a8x_EMZ-m8l5iiRqHg9A94uwMZJmlHsMQ/exec';
    const DATA_API_URL = 'https://script.google.com/macros/s/AKfycbwDyhV3_v1mciIkytxu5P0X0JDhqVkHx6vmdx2i6OLkVD4BzReNgRLQn5beQPEiPEi_jw/exec';
    /*****************************************************************
     * ÉTAT GLOBAL + STOCKAGE LOCAL
     *****************************************************************/
    let currentUser = null;
    let currentView = 'dashboard';
    let localData = {
        projects: [],
        tasks: [],
        members: [],
        users: [],
        lastSync: null,
        pendingChanges: []
    };
    let accessibleProjects = [];

    /*****************************************************************
     * GESTION DU STOCKAGE LOCAL
     *****************************************************************/
    function saveLocalData() {
        localStorage.setItem('projectManagerData', JSON.stringify(localData));
        console.log('Données sauvegardées localement');
    }

    function loadLocalData() {
        const saved = localStorage.getItem('projectManagerData');
        if (saved) {
            try {
                localData = JSON.parse(saved);
                console.log('Données chargées depuis le stockage local');
                updateSyncTime();
                return true;
            } catch (e) {
                console.error('Erreur chargement données locales:', e);
                initLocalData();
            }
        } else {
            initLocalData();
        }
        return false;
    }

    function initLocalData() {
        localData = {
            projects: [],
            tasks: [],
            members: [],
            users: [],
            lastSync: null,
            pendingChanges: []
        };
        saveLocalData();
    }

    function updateSyncTime() {
        if (localData.lastSync) {
            const date = new Date(localData.lastSync);
            document.getElementById('lastSyncTime').textContent = date.toLocaleString();
            document.getElementById('adminSyncTime').textContent = date.toLocaleString();
        }
    }

    /*****************************************************************
     * SYNCHRONISATION
     *****************************************************************/
    async function syncWithServer() {
        showLoading(true);
        showSyncStatus('Synchronisation en cours...', 'warning');
        
        try {
            // Récupérer les données du serveur
            const [serverProjects, serverTasks, serverMembers, serverUsers] = await Promise.all([
                apiCall(DATA_API_URL, 'getProjects'),
                apiCall(DATA_API_URL, 'getTasks'),
                apiCall(DATA_API_URL, 'getMembers'),
                apiCall(DATA_API_URL, 'getUsers')
            ]);

            console.log('Données reçues du serveur:', {
                projects: serverProjects?.length,
                tasks: serverTasks?.length,
                members: serverMembers?.length,
                users: serverUsers?.length
            });

            // Mettre à jour les données locales AVANT d'appliquer les changements en attente
            localData.projects = serverProjects || [];
            localData.tasks = serverTasks || [];
            localData.members = serverMembers || [];
            localData.users = serverUsers || [];

            // Appliquer les changements en attente
            await applyPendingChanges();

            // Maintenant recharger les données fraîches du serveur pour s'assurer d'avoir tout
            const [freshProjects, freshTasks, freshMembers, freshUsers] = await Promise.all([
                apiCall(DATA_API_URL, 'getProjects'),
                apiCall(DATA_API_URL, 'getTasks'),
                apiCall(DATA_API_URL, 'getMembers'),
                apiCall(DATA_API_URL, 'getUsers')
            ]);

            // Utiliser les données fraîches
            localData.projects = freshProjects || [];
            localData.tasks = freshTasks || [];
            localData.members = freshMembers || [];
            localData.users = freshUsers || [];
            
            localData.lastSync = new Date().toISOString();
            localData.pendingChanges = []; // Vider la file d'attente après synchro réussie

            saveLocalData();
            updateSyncTime();
            showSyncStatus('Synchronisation réussie!', 'success');
            
            console.log('Données après synchro:', {
                projects: localData.projects.length,
                tasks: localData.tasks.length,
                members: localData.members.length,
                users: localData.users.length
            });
            
            // Forcer le rechargement de la vue actuelle
            forceRefreshData();
            
        } catch (error) {
            console.error('Erreur synchronisation:', error);
            showSyncStatus('Erreur de synchronisation: ' + error.message, 'error');
        } finally {
            showLoading(false);
        }
    }

    async function applyPendingChanges() {
        if (localData.pendingChanges.length === 0) return;

        console.log(`Application de ${localData.pendingChanges.length} changements en attente`);
        
        const results = [];
        for (const change of localData.pendingChanges) {
            try {
                console.log('Application changement:', change.action, change.data);
                const result = await apiCall(DATA_API_URL, change.action, change.data);
                results.push({ success: true, change, result });
                console.log('Changement appliqué avec succès:', change.action);
            } catch (error) {
                console.error('Erreur application changement:', change.action, error);
                results.push({ success: false, change, error });
            }
        }

        // Vider la file d'attente seulement si tous les changements ont réussi
        const allSuccess = results.every(r => r.success);
        if (allSuccess) {
            localData.pendingChanges = [];
            console.log('Tous les changements ont été synchronisés');
        } else {
            // Garder seulement les changements qui ont échoué
            localData.pendingChanges = localData.pendingChanges.filter((change, index) => 
                !results[index].success
            );
            console.log(`${results.filter(r => r.success).length} changements synchronisés, ${localData.pendingChanges.length} échecs`);
        }
        
        saveLocalData();
    }

    function addPendingChange(action, data) {
        localData.pendingChanges.push({
            action,
            data,
            timestamp: new Date().toISOString()
        });
        saveLocalData();
    }

    function showSyncStatus(message, type) {
        // Supprimer les anciens status
        const oldStatus = document.getElementById('syncStatus');
        if (oldStatus) oldStatus.remove();

        // Créer le nouveau status
        const statusDiv = document.createElement('div');
        statusDiv.id = 'syncStatus';
        statusDiv.className = `sync-status sync-${type}`;
        statusDiv.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-exclamation-triangle' : 'bi-arrow-repeat'}"></i>
            ${message}
        `;
        
        document.body.appendChild(statusDiv);

        // Auto-suppression après 3 secondes
        setTimeout(() => {
            if (statusDiv.parentNode) {
                statusDiv.remove();
            }
        }, 3000);
    }

    function forceRefreshData() {
        console.log('Rafraîchissement forcé des données');
        determineAccessibleProjects();
        
        // Réinitialiser les sélecteurs
        const projectFilter = document.getElementById('projectFilter');
        if (projectFilter) {
            projectFilter.innerHTML = '<option value="">Tous les projets</option>';
        }
        
        // Forcer le rechargement de la vue actuelle
        if (currentView) {
            showView(currentView, true);
        }
    }

    /*****************************************************************
     * FONCTION API GÉNÉRIQUE
     *****************************************************************/
    async function apiCall(apiUrl, action, body = null) {
        try {
            let url = apiUrl + '?action=' + encodeURIComponent(action);
            
            if (body && typeof body === 'object') {
                const params = new URLSearchParams();
                for (const key in body) {
                    if (body[key] !== null && body[key] !== undefined) {
                        params.append(key, body[key]);
                    }
                }
                url += '&' + params.toString();
            }

            const options = { method: 'GET' };
            const resp = await fetch(url, options);
            const text = await resp.text();
            
            try {
                return JSON.parse(text);
            } catch (err) {
                if (text.includes('success') || text.includes('true')) {
                    return { success: true };
                }
                return { success: false, error: 'Réponse non JSON' };
            }
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    /*****************************************************************
     * AUTHENTIFICATION
     *****************************************************************/
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const code = document.getElementById('code').value.trim();

        if (!email || !code) {
            Swal.fire('Erreur', 'Remplissez email et code', 'error');
            return;
        }

        try {
            showLoading(true);
            
            const result = await apiCall(AUTH_API_URL, 'authenticate', { email, code });

            if (result && result.success) {
                currentUser = result.user || { 
                    email: email, 
                    role: result.role || 'Utilisateur',
                    name: email.split('@')[0]
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // Charger les données locales
                loadLocalData();
                showApp();
                
                // Synchroniser en arrière-plan
                setTimeout(() => syncWithServer(), 1000);
                
                Swal.fire('Succès', 'Connexion réussie!', 'success');
            } else {
                Swal.fire('Erreur', result.error || 'Email ou code incorrect', 'error');
            }
        } catch (error) {
            console.error('Erreur login:', error);
            Swal.fire('Erreur', 'Impossible de se connecter', 'error');
        } finally {
            showLoading(false);
        }
    });

    /*****************************************************************
     * INTERFACE UTILISATEUR
     *****************************************************************/
    function showApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        updateUserInfo();
        setupNavigation();
        checkAdminAccess();
        showView('dashboard');
    }

    function updateUserInfo() {
        if (!currentUser) return;
        document.getElementById('userName').textContent = currentUser.name || currentUser.email.split('@')[0];
        document.getElementById('userRole').textContent = currentUser.role || '';
    }

    function checkAdminAccess() {
        const adminLink = document.querySelector('[data-view="admin"]');
        if (!currentUser || currentUser.role !== 'Administrateur') {
            adminLink.style.display = 'none';
        } else {
            adminLink.style.display = '';
        }
    }

    function setupNavigation() {
        document.querySelectorAll('[data-view]').forEach(link => {
            link.addEventListener('click', (ev) => {
                ev.preventDefault();
                const view = link.getAttribute('data-view');
                showView(view);
            });
        });

        document.getElementById('syncBtn').addEventListener('click', async (ev) => {
            ev.preventDefault();
            await syncWithServer();
        });

        document.getElementById('logoutBtn').addEventListener('click', (ev) => {
            ev.preventDefault();
            logout();
        });
    }

    function showView(viewName, forceRefresh = false) {
        currentView = viewName;
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        const viewEl = document.getElementById(viewName);
        if (!viewEl) return;
        viewEl.classList.add('active');

        document.querySelectorAll('[data-view]').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[data-view="${viewName}"]`);
        if (activeLink) activeLink.classList.add('active');

        const titles = { 
            dashboard: 'Tableau de bord', 
            projects: 'Gestion des Projets', 
            tasks: 'Gestion des Tâches', 
            members: 'Gestion des Membres', 
            admin: 'Administration' 
        };
        document.getElementById('viewTitle').textContent = titles[viewName] || 'Vue';

        // Forcer le recalcul des projets accessibles
        if (forceRefresh) {
            determineAccessibleProjects();
        }

        // Utiliser les données locales pour un affichage instantané
        if (viewName === 'dashboard') loadDashboard();
        if (viewName === 'projects') loadProjects();
        if (viewName === 'tasks') loadTasks();
        if (viewName === 'members') loadMembers();
        if (viewName === 'admin') loadAdmin();
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('active', !!show);
    }

    function logout() {
        localStorage.removeItem('currentUser');
        localStorage.removeItem('projectManagerData');
        currentUser = null;
        location.reload();
    }

    /*****************************************************************
     * GESTION DES DONNÉES LOCALES
     *****************************************************************/
    function determineAccessibleProjects() {
        if (!currentUser) { accessibleProjects = []; return; }
        if (currentUser.role === 'Administrateur') {
            accessibleProjects = [...localData.projects];
            return;
        }
        if (currentUser.role === 'Responsable Projet') {
            accessibleProjects = localData.projects.filter(p => String(p.manager) === String(currentUser.email));
            return;
        }
        const projectIds = new Set(localData.tasks.filter(t => String(t.assignéeà) === String(currentUser.email)).map(t => String(t.projectid)));
        accessibleProjects = localData.projects.filter(p => projectIds.has(String(p.id)));
    }

    function getAccessibleTasks() {
        if (!currentUser) return [];
        if (currentUser.role === 'Administrateur') return localData.tasks;
        if (currentUser.role === 'Responsable Projet') {
            const ids = new Set(accessibleProjects.map(p => String(p.id)));
            return localData.tasks.filter(t => ids.has(String(t.projectid)));
        }
        return localData.tasks.filter(t => String(t.assignéeà) === String(currentUser.email));
    }

    /*****************************************************************
     * AFFICHAGE DES DONNÉES (LOCALES)
     *****************************************************************/
    function loadDashboard() {
        determineAccessibleProjects();
        const accessibleTasks = getAccessibleTasks();
        const userTasks = accessibleTasks.filter(t => String(t.assignéeà) === String(currentUser.email));
        
        document.getElementById('projectCount').textContent = accessibleProjects.length;
        document.getElementById('taskCount').textContent = userTasks.length;
        document.getElementById('completedCount').textContent = userTasks.filter(t => t.statut === 'Terminé').length;

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('lateCount').textContent = userTasks.filter(t => 
            (t.datefin || '') < today && t.statut !== 'Terminé'
        ).length;

        const recentTasksContainer = document.getElementById('recentTasks');
        recentTasksContainer.innerHTML = '';

        const recentTasks = userTasks
            .sort((a, b) => new Date(b.datefin || 0) - new Date(a.datefin || 0))
            .slice(0, 5);

        if (recentTasks.length === 0) {
            recentTasksContainer.innerHTML = '<p class="text-muted">Aucune tâche assignée</p>';
            return;
        }

        recentTasks.forEach(task => {
            const project = localData.projects.find(p => String(p.id) === String(task.projectid));
            const wrapper = document.createElement('div');
            wrapper.className = 'task-card';

            wrapper.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h6 style="margin: 0 0 6px 0;">${escapeHtml(task.nom || 'Tâche')}</h6>
                        <small class="text-muted">${escapeHtml(project ? project.nom : 'Projet')}</small><br>
                        ${task.description ? `<small>${escapeHtml(task.description.length > 60 ? task.description.substring(0, 60) + '...' : task.description)}</small><br>` : ''}
                        <small>Dates: ${formatDate(task.datedebut) || '-'} au ${formatDate(task.datefin) || '-'}</small>
                    </div>
                    <div>
                        <span class="badge-priority" style="background: ${task.priorité === 'Haute' ? '#dc3545' : task.priorité === 'Moyenne' ? '#ffc107' : '#28a745'}">
                            ${task.priorité || 'Moyenne'}
                        </span>
                        <span class="badge ms-1 mt-1" style="background: ${task.statut === 'Terminé' ? '#28a745' : task.statut === 'En cours' ? '#007bff' : '#6c757d'}; color: #fff;">
                            ${task.statut || 'À faire'}
                        </span>
                    </div>
                </div>
            `;
            recentTasksContainer.appendChild(wrapper);
        });
    }

    function loadProjects() {
        determineAccessibleProjects();
        const tbody = document.getElementById('projectsTable');
        tbody.innerHTML = '';
        
        accessibleProjects.forEach(project => {
            const manager = localData.members.find(m => String(m.email) === String(project.manager));
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td><strong>${escapeHtml(project.nom || '-')}</strong></td>
                <td>${escapeHtml(project.description || '-')}</td>
                <td>${formatDate(project.datedébut) || '-'} à ${formatDate(project.datefin) || '-'}</td>
                <td>${escapeHtml(manager ? manager.nom : (project.manager || '-'))}</td>
                <td>
                    ${currentUser.role === 'Administrateur' || currentUser.role === 'Responsable Projet' ? 
                        `<button class="btn btn-sm btn-warning me-1" onclick="editProject('${project.id}')">
                            <i class="bi bi-pencil"></i>
                         </button>
                         <button class="btn btn-sm btn-danger" onclick="deleteProject('${project.id}')">
                            <i class="bi bi-trash"></i>
                         </button>` :
                        `<button class="btn btn-sm btn-info">
                            <i class="bi bi-eye"></i>
                         </button>`
                    }
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Remplir le select des managers
        const managerSelect = document.getElementById('projectManager');
        managerSelect.innerHTML = '<option value="">Sélectionner un membre</option>';
        localData.members.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.email;
            opt.textContent = m.nom;
            managerSelect.appendChild(opt);
        });
    }

    function loadTasks() {
        console.log('Chargement des tâches, données disponibles:', {
            projects: localData.projects.length,
            tasks: localData.tasks.length,
            members: localData.members.length,
            accessibleProjects: accessibleProjects.length
        });

        determineAccessibleProjects();
        const accessibleTasks = getAccessibleTasks();
        
        console.log('Tâches accessibles:', accessibleTasks.length);
        console.log('Tâches complètes:', accessibleTasks);

        const tasksList = document.getElementById('tasksList');
        const projectFilter = document.getElementById('projectFilter');

        projectFilter.innerHTML = '<option value="">Tous les projets</option>';
        accessibleProjects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.nom;
            projectFilter.appendChild(opt);
        });

        function renderFiltered() {
            const pid = projectFilter.value;
            const status = document.getElementById('statusFilter').value;
            let filtered = accessibleTasks.slice();
            
            if (pid) filtered = filtered.filter(t => String(t.projectid) === String(pid));
            if (status) filtered = filtered.filter(t => t.statut === status);

            tasksList.innerHTML = '';
            
            if (filtered.length === 0) {
                tasksList.innerHTML = '<p class="text-muted">Aucune tâche trouvée</p>';
                return;
            }

            filtered.forEach(task => {
                const project = localData.projects.find(p => String(p.id) === String(task.projectid));
                const assignee = localData.members.find(m => String(m.email) === String(task.assignéeà));
                const canEdit = currentUser.role === 'Administrateur' || 
                               (currentUser.role === 'Responsable Projet' && 
                                accessibleProjects.find(p => String(p.id) === String(task.projectid)));

                // CORRECTION : Afficher correctement les dates de début et fin
                const startDate = task.datedebut || task.startdate || task.datedébut || '-';
                const endDate = task.datefin || task.enddate || '-';

                tasksList.innerHTML += `
                    <div class="task-card">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 6px 0;">${escapeHtml(task.nom)}</h6>
                                <small class="text-muted">${escapeHtml(project ? project.nom : 'Projet')}</small><br>
                                ${task.description ? `<small>Description: ${escapeHtml(task.description)}</small><br>` : ''}
                                <small>Assigné à: ${escapeHtml(assignee ? assignee.nom : task.assignéeà)}</small><br>
                                <small>Dates: ${formatDate(startDate) || '-'} au ${formatDate(endDate) || '-'}</small>
                            </div>
                            <div>
                                <span class="badge-priority" style="background: ${task.priorité === 'Haute' ? '#dc3545' : task.priorité === 'Moyenne' ? '#ffc107' : '#28a745'}">
                                    ${task.priorité}
                                </span><br>
                                <span class="badge ms-1 mt-1" style="background: ${task.statut === 'Terminé' ? '#28a745' : task.statut === 'En cours' ? '#007bff' : '#6c757d'}; color: #fff;">
                                    ${task.statut}
                                </span>
                            </div>
                        </div>
                        ${canEdit ? `
                        <div class="mt-2">
                            <button class="btn btn-sm btn-warning me-1" onclick="editTask('${task.id}')">
                                <i class="bi bi-pencil"></i> Modifier
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.id}')">
                                <i class="bi bi-trash"></i> Supprimer
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
        }

        projectFilter.addEventListener('change', renderFiltered);
        document.getElementById('statusFilter').addEventListener('change', renderFiltered);
        renderFiltered();

        // Remplir les selects du formulaire
        const taskProject = document.getElementById('taskProject');
        taskProject.innerHTML = '<option value="">Sélectionner un projet</option>';
        accessibleProjects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.nom;
            taskProject.appendChild(opt);
        });

        const taskAssignee = document.getElementById('taskAssignee');
        taskAssignee.innerHTML = '<option value="">Sélectionner un membre</option>';
        localData.members.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.email;
            opt.textContent = m.nom;
            taskAssignee.appendChild(opt);
        });
    }

    function loadMembers() {
        const membersTable = document.getElementById('membersTable');
        membersTable.innerHTML = '';

        let displayMembers = localData.members;
        if (currentUser.role === 'Responsable Projet') {
            const projectIds = new Set(accessibleProjects.map(p => String(p.id)));
            const memberEmails = new Set(localData.tasks.filter(t => projectIds.has(String(t.projectid))).map(t => String(t.assignéeà)));
            displayMembers = localData.members.filter(m => memberEmails.has(String(m.email)));
        }

        displayMembers.forEach(member => {
            const memberTasks = localData.tasks.filter(t => String(t.assignéeà) === String(member.email));
            const canEdit = currentUser.role === 'Administrateur';

            membersTable.innerHTML += `
                <tr>
                    <td>${escapeHtml(member.nom)}</td>
                    <td>${escapeHtml(member.email)}</td>
                    <td>${escapeHtml(member.rôle)}</td>
                    <td>${memberTasks.length}</td>
                    <td>
                        ${canEdit ? `
                        <button class="btn btn-sm btn-warning me-1" onclick="editMember('${member.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMember('${member.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
    }

    function loadAdmin() {
        if (!currentUser || currentUser.role !== 'Administrateur') {
            Swal.fire('Accès refusé', 'Vous n\'avez pas accès à cette section', 'error');
            return;
        }

        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';

        localData.users.forEach(u => {
            usersList.innerHTML += `
                <div class="card mb-2">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(u.email)}</strong><br>
                            <small class="text-muted">${escapeHtml(u.rôle || '')}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.email}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        document.getElementById('usersCount').textContent = localData.users.length;
        document.getElementById('membersCount').textContent = localData.members.length;
        document.getElementById('projectsCount').textContent = localData.projects.length;
        document.getElementById('tasksCount').textContent = localData.tasks.length;
        updateSyncTime();
    }

    /*****************************************************************
     * ACTIONS CRUD (LOCALES + SYNCHRO)
     *****************************************************************/
    document.getElementById('saveProjectBtn').addEventListener('click', saveProject);
    document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
    document.getElementById('saveMemberBtn').addEventListener('click', saveMember);
    document.getElementById('saveUserBtn').addEventListener('click', saveUser);

    function generateId() {
        return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function saveProject() {
        const name = document.getElementById('projectName').value.trim();
        const description = document.getElementById('projectDesc').value.trim();
        const startDate = document.getElementById('projectStart').value;
        const endDate = document.getElementById('projectEnd').value;
        const manager = document.getElementById('projectManager').value;

        if (!name || !startDate || !endDate || !manager) { 
            Swal.fire('Erreur', 'Remplissez tous les champs obligatoires', 'error'); 
            return; 
        }

        try {
            const newProject = {
                id: generateId(),
                nom: name,
                description: description,
                datedébut: startDate,
                datefin: endDate,
                manager: manager
            };

            // Ajouter localement
            localData.projects.push(newProject);
            saveLocalData();

            // Mettre à jour l'affichage IMMÉDIATEMENT
            determineAccessibleProjects();
            showView('projects');

            // Ajouter à la file d'attente de synchro
            addPendingChange('addProject', {
                name: name,
                description: description,
                startDate: startDate,
                endDate: endDate,
                manager: manager
            });

            Swal.fire({
                title: 'Succès', 
                text: 'Projet créé avec succès',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'OK',
                cancelButtonText: 'Synchroniser maintenant'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    // L'utilisateur a cliqué sur "Synchroniser maintenant"
                    syncWithServer();
                }
            });

            bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
            document.getElementById('projectForm').reset();
            
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function saveTask() {
        const name = document.getElementById('taskName').value.trim();
        const description = document.getElementById('taskDescription').value.trim();
        const projectId = document.getElementById('taskProject').value;
        const assignee = document.getElementById('taskAssignee').value;
        const status = document.getElementById('taskStatus').value;
        const priority = document.getElementById('taskPriority').value;
        const startDate = document.getElementById('taskStart').value;
        const endDate = document.getElementById('taskEnd').value;

        if (!name || !projectId || !assignee || !startDate || !endDate) { 
            Swal.fire('Erreur', 'Remplissez tous les champs obligatoires', 'error'); 
            return; 
        }

        try {
            const newTask = {
                id: generateId(),
                nom: name,
                description: description,
                projectid: projectId,
                assignéeà: assignee,
                statut: status,
                priorité: priority,
                datedebut: startDate,
                datefin: endDate
            };

            // Ajouter localement
            localData.tasks.push(newTask);
            saveLocalData();

            // Mettre à jour l'affichage IMMÉDIATEMENT
            determineAccessibleProjects();
            showView('tasks');

            // Ajouter à la file d'attente de synchro
            addPendingChange('addTask', {
                name: name,
                description: description,
                projectId: projectId,
                assignee: assignee,
                status: status,
                priority: priority,
                startDate: startDate,
                endDate: endDate
            });

            Swal.fire({
                title: 'Succès', 
                text: 'Tâche créée avec succès',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'OK',
                cancelButtonText: 'Synchroniser maintenant'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    // L'utilisateur a cliqué sur "Synchroniser maintenant"
                    syncWithServer();
                }
            });

            bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
            document.getElementById('taskForm').reset();
            
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function saveMember() {
        const name = document.getElementById('memberName').value.trim();
        const email = document.getElementById('memberEmail').value.trim();
        const role = document.getElementById('memberRole').value;

        if (!name || !email || !role) { 
            Swal.fire('Erreur', 'Remplissez tous les champs', 'error'); 
            return; 
        }

        try {
            const newMember = {
                id: generateId(),
                nom: name,
                email: email,
                rôle: role
            };

            // Ajouter localement
            localData.members.push(newMember);
            saveLocalData();

            // Mettre à jour l'affichage IMMÉDIATEMENT
            showView('members');

            // Ajouter à la file d'attente de synchro
            addPendingChange('addMember', {
                name: name,
                email: email,
                role: role
            });

            Swal.fire({
                title: 'Succès', 
                text: 'Membre ajouté avec succès',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'OK',
                cancelButtonText: 'Synchroniser maintenant'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    // L'utilisateur a cliqué sur "Synchroniser maintenant"
                    syncWithServer();
                }
            });

            bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
            document.getElementById('memberForm').reset();
            
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function saveUser() {
        // CORRECTION : Utiliser le bon ID pour l'email
        const email = document.getElementById('userEmail').value.trim();
        const code = document.getElementById('userCode').value.trim();
        const role = document.getElementById('userRole').value;

        if (!email || !code || !role) { 
            Swal.fire('Erreur', 'Remplissez tous les champs', 'error'); 
            return; 
        }

        try {
            const newUser = {
                email: email,
                code: code,
                rôle: role
            };

            // Vérifier si l'utilisateur existe déjà
            const existingUser = localData.users.find(u => u.email === email);
            if (existingUser) {
                Swal.fire('Erreur', 'Un utilisateur avec cet email existe déjà', 'error');
                return;
            }

            // Ajouter localement
            localData.users.push(newUser);
            saveLocalData();

            // Mettre à jour l'affichage IMMÉDIATEMENT
            loadAdmin();

            // Ajouter à la file d'attente de synchro
            addPendingChange('addUser', {
                email: email,
                code: code,
                role: role
            });

            Swal.fire({
                title: 'Succès', 
                text: 'Utilisateur créé avec succès',
                icon: 'success',
                showCancelButton: true,
                confirmButtonText: 'OK',
                cancelButtonText: 'Synchroniser maintenant'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    // L'utilisateur a cliqué sur "Synchroniser maintenant"
                    syncWithServer();
                }
            });

            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            document.getElementById('userForm').reset();
            
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function deleteProject(projectId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        
        // Supprimer localement
        localData.projects = localData.projects.filter(p => p.id !== projectId);
        saveLocalData();

        // Mettre à jour l'affichage
        determineAccessibleProjects();
        showView('projects');

        // Ajouter à la file d'attente de synchro
        addPendingChange('deleteProject', { id: projectId });

        Swal.fire('Succès', 'Projet supprimé', 'success');
    }

    async function deleteTask(taskId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        
        // Supprimer localement
        localData.tasks = localData.tasks.filter(t => t.id !== taskId);
        saveLocalData();

        // Mettre à jour l'affichage
        determineAccessibleProjects();
        showView('tasks');

        // Ajouter à la file d'attente de synchro
        addPendingChange('deleteTask', { id: taskId });

        Swal.fire('Succès', 'Tâche supprimée', 'success');
    }

    async function deleteMember(memberId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        
        // Supprimer localement
        localData.members = localData.members.filter(m => m.id !== memberId);
        saveLocalData();

        // Mettre à jour l'affichage
        showView('members');

        // Ajouter à la file d'attente de synchro
        addPendingChange('deleteMember', { id: memberId });

        Swal.fire('Succès', 'Membre supprimé', 'success');
    }

    async function deleteUser(email) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        
        // Supprimer localement
        localData.users = localData.users.filter(u => u.email !== email);
        saveLocalData();

        // Mettre à jour l'affichage
        loadAdmin();

        // Ajouter à la file d'attente de synchro
        addPendingChange('deleteUser', { email: email });

        Swal.fire('Succès', 'Utilisateur supprimé', 'success');
    }

    function editProject(projectId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }
    function editTask(taskId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }
    function editMember(memberId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }

    /*****************************************************************
     * INITIALISATION
     *****************************************************************/
    window.addEventListener('load', async () => {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try { 
                currentUser = JSON.parse(savedUser); 
                loadLocalData();
                showApp();
            } catch (e) { 
                console.warn('session parse error', e); 
                localStorage.removeItem('currentUser'); 
            }
        }
    });

    /*****************************************************************
     * UTILITAIRES
     *****************************************************************/
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        try {
            // Gérer différents formats de date
            let date;
            if (dateString.includes('/')) {
                // Format DD/MM/YYYY
                const parts = dateString.split('/');
                date = new Date(parts[2], parts[1] - 1, parts[0]);
            } else if (dateString.includes('-')) {
                // Format YYYY-MM-DD
                date = new Date(dateString);
            } else {
                date = new Date(dateString);
            }
            
            return date.toLocaleDateString('fr-FR');
        } catch (e) {
            console.warn('Erreur format date:', dateString, e);
            return dateString;
        }
    }
    </script>
</body>
</html>
