<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion de Projets - Google Sheets</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        }
        .login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
        .login-box {
            width:100%; max-width:420px; background:#fff; border-radius:12px; padding:32px;
            box-shadow:0 10px 40px rgba(0,0,0,0.25);
        }
        .btn-login { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border:none; color:#fff; }
        .app-container { display:none; min-height:100vh; }
        .sidebar {
            position:fixed; left:0; top:0; width:250px; min-height:100vh;
            background: linear-gradient(180deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px 10px; overflow:auto;
        }
        .main-content { margin-left:250px; padding:30px; }
        .view-section { display:none; }
        .view-section.active { display:block; }
        .task-card { background:#fff; border-left:4px solid #667eea; padding:12px; border-radius:8px; margin-bottom:12px; }
        .badge-priority { font-size:0.85rem; padding:5px 8px; border-radius:6px; color:#fff; }
        .loading { display:none; text-align:center; padding:20px; }
        .loading.active { display:block; }
        @media (max-width:768px) {
            .sidebar { width:200px; }
            .main-content { margin-left:200px; padding:18px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2><i class="bi bi-shield-lock"></i> Authentification</h2>
            <p>Connectez-vous à votre espace de gestion de projets</p>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input id="email" type="email" class="form-control" placeholder="votre@email.com" required>
                </div>
                <div class="mb-3">
                    <label for="code" class="form-label">Code d'accès</label>
                    <input id="code" type="password" class="form-control" placeholder="Entrez votre code" required>
                </div>
                <button type="submit" class="btn btn-login w-100">
                    <i class="bi bi-box-arrow-in-right"></i> Se connecter
                </button>
            </form>

            <div class="setup-info mt-3 p-3" style="background:#f0f4ff;border-left:4px solid #667eea;">
                <strong>Identifiants de test:</strong>
                <p style="margin:8px 0 0 0;">Email: <code>admin@example.com</code><br>Code: <code>1234</code></p>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="appContainer" class="app-container">
        <div class="sidebar">
            <div class="sidebar-header text-center mb-3">
                <h3>GestioProj</h3>
                <p style="opacity:0.9; margin:0;">Gestion de Projets</p>
            </div>
            <nav class="nav flex-column">
                <a class="nav-link active text-white" href="#" data-view="dashboard"><i class="bi bi-speedometer2"></i> Tableau de bord</a>
                <a class="nav-link text-white" href="#" data-view="projects"><i class="bi bi-folder"></i> Projets</a>
                <a class="nav-link text-white" href="#" data-view="tasks"><i class="bi bi-list-task"></i> Tâches</a>
                <a class="nav-link text-white" href="#" data-view="members"><i class="bi bi-people"></i> Membres</a>
                <a class="nav-link text-white" href="#" data-view="admin"><i class="bi bi-gear"></i> Administration</a>
                <hr style="opacity:0.3;">
                <a class="nav-link text-white" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Déconnexion</a>
            </nav>
        </div>

        <div class="main-content">
            <div class="header-bar bg-white p-3 rounded mb-3 d-flex justify-content-between align-items-center" style="box-shadow:0 2px 10px rgba(0,0,0,0.08);">
                <h1 id="viewTitle" style="color:#667eea; font-size:1.5rem; margin:0;">Tableau de bord</h1>
                <div class="user-info text-end" style="color:#666;">
                    <p style="margin:0;"><strong id="userName">Utilisateur</strong></p>
                    <p id="userRole" style="margin:0;">Rôle</p>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div>
                <p class="mt-2">Chargement des données...</p>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard" class="view-section active">
                <div class="row mb-3">
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="projectCount" style="color:#667eea;">0</h3>
                            <p>Projets accessibles</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="taskCount" style="color:#764ba2;">0</h3>
                            <p>Tâches assignées</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="completedCount" style="color:#28a745;">0</h3>
                            <p>Tâches terminées</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="lateCount" style="color:#dc3545;">0</h3>
                            <p>Tâches en retard</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-gradient" style="background:linear-gradient(135deg,#667eea,#764ba2); color:#fff;">
                        <h5 class="mb-0">Tâches récentes</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentTasks"></div>
                    </div>
                </div>
            </div>

            <!-- PROJECTS -->
            <div id="projects" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Projets</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projectModal">
                        <i class="bi bi-plus-circle"></i> Nouveau projet
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Description</th>
                                    <th>Dates</th>
                                    <th>Responsable</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TASKS -->
            <div id="tasks" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Tâches</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="bi bi-plus-circle"></i> Nouvelle tâche
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4 mb-2">
                        <select id="projectFilter" class="form-select"><option value="">Tous les projets</option></select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <select id="statusFilter" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option>À faire</option>
                            <option>En cours</option>
                            <option>Terminé</option>
                        </select>
                    </div>
                </div>

                <div id="tasksList"></div>
            </div>

            <!-- MEMBERS -->
            <div id="members" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Membres</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#memberModal">
                        <i class="bi bi-plus-circle"></i> Nouveau membre
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Projets</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="admin" class="view-section">
                <h2>Administration</h2>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">Gestion des utilisateurs</div>
                            <div class="card-body">
                                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userModal">
                                    <i class="bi bi-person-plus"></i> Ajouter un utilisateur
                                </button>
                                <div id="usersList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">Informations système</div>
                            <div class="card-body">
                                <p><strong>Utilisateurs:</strong> <span id="usersCount">0</span></p>
                                <p><strong>Membres:</strong> <span id="membersCount">0</span></p>
                                <p><strong>Projets:</strong> <span id="projectsCount">0</span></p>
                                <p><strong>Tâches:</strong> <span id="tasksCount">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALS -->
    <!-- Project Modal -->
    <div class="modal fade" id="projectModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau projet</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="projectForm">
                <div class="mb-3"><label class="form-label">Nom du projet *</label><input id="projectName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea id="projectDesc" class="form-control" rows="3"></textarea></div>
                <div class="mb-3"><label class="form-label">Date de début *</label><input id="projectStart" type="date" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Date de fin *</label><input id="projectEnd" type="date" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Responsable *</label><select id="projectManager" class="form-select" required><option value="">Sélectionner un membre</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveProjectBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouvelle tâche</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="mb-3"><label class="form-label">Nom de la tâche *</label><input id="taskName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea id="taskDescription" class="form-control" rows="3"></textarea></div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Projet *</label><select id="taskProject" class="form-select" required><option value="">Sélectionner un projet</option></select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Assigné à *</label><select id="taskAssignee" class="form-select" required><option value="">Sélectionner un membre</option></select></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Date de début *</label><input id="taskStart" type="date" class="form-control" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Date de fin *</label><input id="taskEnd" type="date" class="form-control" required></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Statut</label><select id="taskStatus" class="form-select"><option>À faire</option><option>En cours</option><option>Terminé</option></select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Priorité</label><select id="taskPriority" class="form-select"><option>Basse</option><option selected>Moyenne</option><option>Haute</option></select></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveTaskBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- Member Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau membre</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="memberForm">
                <div class="mb-3"><label class="form-label">Nom *</label><input id="memberName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Email *</label><input id="memberEmail" type="email" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Rôle *</label><select id="memberRole" class="form-select" required><option value="">Sélectionner</option><option>Développeur</option><option>Designer</option><option>Manager</option><option>QA</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveMemberBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Ajouter un utilisateur système</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="userForm">
                <div class="mb-3"><label class="form-label">Email *</label><input id="userName" type="email" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Code d'accès *</label><input id="userCode" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Rôle *</label><select id="userRole" class="form-select" required><option>Utilisateur</option><option>Responsable Projet</option><option>Administrateur</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveUserBtn">Enregistrer</button></div>
    </div></div></div>

    <script>
    /*****************************************************************
     * CONFIGURATION
     *****************************************************************/
    const AUTH_API_URL = 'https://script.google.com/macros/s/AKfycbybESlz7o1UL0NZHM6zCO0SdZWw8o3RrQxF1a8x_EMZ-m8l5iiRqHg9A94uwMZJmlHsMQ/exec';
    const DATA_API_URL = 'https://script.google.com/macros/s/AKfycbwDyhV3_v1mciIkytxu5P0X0JDhqVkHx6vmdx2i6OLkVD4BzReNgRLQn5beQPEiPEi_jw/exec';

    /*****************************************************************
     * ÉTAT GLOBAL
     *****************************************************************/
    let currentUser = null;
    let allProjects = [];
    let allTasks = [];
    let allMembers = [];
    let allUsers = [];
    let accessibleProjects = [];

    /*****************************************************************
     * FONCTION API GÉNÉRIQUE
     *****************************************************************/
    async function api(apiUrl, action, method = 'GET', body = null) {
        try {
            let url = apiUrl + '?action=' + encodeURIComponent(action);
            
            if (body && typeof body === 'object') {
                const params = new URLSearchParams();
                for (const key in body) {
                    if (body[key] !== null && body[key] !== undefined) {
                        params.append(key, body[key]);
                    }
                }
                url += '&' + params.toString();
            }

            console.log('API Call:', url);
            
            const options = { 
                method: 'GET',
                headers: {}
            };

            const resp = await fetch(url, options);
            const text = await resp.text();
            console.log('API Response:', text);
            
            try {
                const result = JSON.parse(text);
                return result;
            } catch (err) {
                if (text.includes('success') || text.includes('true')) {
                    return { success: true };
                }
                if (text.includes('error') || text.includes('false')) {
                    return { success: false, error: 'Erreur serveur' };
                }
                return { success: false, error: 'Réponse non JSON: ' + text };
            }
        } catch (error) {
            console.error('API Error:', error);
            return { success: false, error: error.message || String(error) };
        }
    }

    /*****************************************************************
     * AUTHENTIFICATION
     *****************************************************************/
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const code = document.getElementById('code').value.trim();

        if (!email || !code) {
            Swal.fire('Erreur', 'Remplissez email et code', 'error');
            return;
        }

        try {
            showLoading(true);
            
            const result = await api(AUTH_API_URL, 'authenticate', 'GET', { 
                email: email, 
                code: code 
            });

            console.log('Login result:', result);

            if (result && result.success) {
                currentUser = result.user || { 
                    email: email, 
                    role: result.role || 'Utilisateur',
                    name: email.split('@')[0]
                };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showApp();
                await loadAllData();
                Swal.fire('Succès', 'Connexion réussie!', 'success');
            } else {
                Swal.fire('Erreur', result.error || 'Email ou code incorrect', 'error');
            }
        } catch (error) {
            console.error('Erreur login:', error);
            Swal.fire('Erreur', 'Impossible de se connecter', 'error');
        } finally {
            showLoading(false);
        }
    });

    /*****************************************************************
     * INTERFACE UTILISATEUR
     *****************************************************************/
    function showApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        updateUserInfo();
        setupNavigation();
        checkAdminAccess();
    }

    function updateUserInfo() {
        if (!currentUser) return;
        document.getElementById('userName').textContent = currentUser.name || currentUser.email.split('@')[0];
        document.getElementById('userRole').textContent = currentUser.role || '';
    }

    function checkAdminAccess() {
        const adminLink = document.querySelector('[data-view="admin"]');
        if (!currentUser || currentUser.role !== 'Administrateur') {
            adminLink.style.display = 'none';
        } else {
            adminLink.style.display = '';
        }
    }

    function setupNavigation() {
        document.querySelectorAll('[data-view]').forEach(link => {
            link.addEventListener('click', (ev) => {
                ev.preventDefault();
                const view = link.getAttribute('data-view');
                showView(view);
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', (ev) => {
            ev.preventDefault();
            logout();
        });
    }

    function showView(viewName) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        const viewEl = document.getElementById(viewName);
        if (!viewEl) return;
        viewEl.classList.add('active');

        document.querySelectorAll('[data-view]').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[data-view="${viewName}"]`);
        if (activeLink) activeLink.classList.add('active');

        const titles = { 
            dashboard: 'Tableau de bord', 
            projects: 'Gestion des Projets', 
            tasks: 'Gestion des Tâches', 
            members: 'Gestion des Membres', 
            admin: 'Administration' 
        };
        document.getElementById('viewTitle').textContent = titles[viewName] || 'Vue';

        if (viewName === 'dashboard') loadDashboard();
        if (viewName === 'projects') loadProjects();
        if (viewName === 'tasks') loadTasks();
        if (viewName === 'members') loadMembers();
        if (viewName === 'admin') loadAdmin();
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('active', !!show);
    }

    function logout() {
        localStorage.removeItem('currentUser');
        currentUser = null;
        location.reload();
    }

    /*****************************************************************
     * CHARGEMENT DES DONNÉES
     *****************************************************************/
    async function loadAllData() {
        showLoading(true);
        try {
            const [pRes, tRes, mRes, uRes] = await Promise.all([
                api(DATA_API_URL, 'getProjects'),
                api(DATA_API_URL, 'getTasks'),
                api(DATA_API_URL, 'getMembers'),
                api(DATA_API_URL, 'getUsers')
            ]);

            allProjects = Array.isArray(pRes) ? pRes : (pRes?.projects || pRes?.data || []);
            allTasks = Array.isArray(tRes) ? tRes : (tRes?.tasks || tRes?.data || []);
            allMembers = Array.isArray(mRes) ? mRes : (mRes?.members || mRes?.data || []);
            allUsers = Array.isArray(uRes) ? uRes : (uRes?.users || uRes?.data || []);

            allProjects = allProjects || [];
            allTasks = allTasks || [];
            allMembers = allMembers || [];
            allUsers = allUsers || [];

            determineAccessibleProjects();
            await loadDashboard();
        } catch (error) {
            console.error('Erreur loadAllData:', error);
            Swal.fire('Erreur', 'Erreur lors du chargement des données', 'error');
        } finally {
            showLoading(false);
        }
    }

    function determineAccessibleProjects() {
        if (!currentUser) { accessibleProjects = []; return; }
        if (currentUser.role === 'Administrateur') {
            accessibleProjects = [...allProjects];
            return;
        }
        if (currentUser.role === 'Responsable Projet') {
            accessibleProjects = allProjects.filter(p => String(p.manager) === String(currentUser.email));
            return;
        }
        const projectIds = new Set(allTasks.filter(t => String(t.assignee) === String(currentUser.email)).map(t => String(t.projectId)));
        accessibleProjects = allProjects.filter(p => projectIds.has(String(p.id)));
    }

    function getAccessibleTasks() {
        if (!currentUser) return [];
        if (currentUser.role === 'Administrateur') return allTasks;
        if (currentUser.role === 'Responsable Projet') {
            const ids = new Set(accessibleProjects.map(p => String(p.id)));
            return allTasks.filter(t => ids.has(String(t.projectId)));
        }
        return allTasks.filter(t => String(t.assignee) === String(currentUser.email));
    }

    /*****************************************************************
     * AFFICHAGE DES DONNÉES
     *****************************************************************/
    async function loadDashboard() {
        const accessibleTasks = getAccessibleTasks();
        document.getElementById('projectCount').textContent = accessibleProjects.length;
        document.getElementById('taskCount').textContent = accessibleTasks.filter(t => String(t.assignee) === String(currentUser.email)).length;
        document.getElementById('completedCount').textContent = accessibleTasks.filter(t => t.status === 'Terminé' && String(t.assignee) === String(currentUser.email)).length;

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('lateCount').textContent = accessibleTasks.filter(t => (t.endDate || '') < today && t.status !== 'Terminé' && String(t.assignee) === String(currentUser.email)).length;

        const recentTasksContainer = document.getElementById('recentTasks');
        recentTasksContainer.innerHTML = '';

        const recentTasks = accessibleTasks
            .filter(t => String(t.assignee) === String(currentUser.email))
            .sort((a, b) => new Date(b.endDate || 0) - new Date(a.endDate || 0))
            .slice(0, 5);

        if (recentTasks.length === 0) {
            recentTasksContainer.innerHTML = '<p class="text-muted">Aucune tâche assignée</p>';
            return;
        }

        recentTasks.forEach(task => {
            const project = allProjects.find(p => String(p.id) === String(task.projectId));
            const wrapper = document.createElement('div');
            wrapper.className = 'task-card';

            wrapper.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <h6 style="margin: 0 0 6px 0;">${escapeHtml(task.name || 'Tâche')}</h6>
                        <small class="text-muted">${escapeHtml(project ? project.name : 'Projet')}</small><br>
                        ${task.description ? `<small>${escapeHtml(task.description.length > 60 ? task.description.substring(0, 60) + '...' : task.description)}</small>` : ''}
                        <small>Dates: ${task.startDate || '-'} au ${task.endDate || '-'}</small>
                    </div>
                    <div>
                        <span class="badge-priority" style="background: ${task.priority === 'Haute' ? '#dc3545' : task.priority === 'Moyenne' ? '#ffc107' : '#28a745'}">
                            ${task.priority || 'Moyenne'}
                        </span>
                        <span class="badge ms-1" style="background: ${task.status === 'Terminé' ? '#28a745' : task.status === 'En cours' ? '#007bff' : '#6c757d'}; color: #fff;">
                            ${task.status || 'À faire'}
                        </span>
                    </div>
                </div>
            `;
            recentTasksContainer.appendChild(wrapper);
        });
    }

    async function loadProjects() {
        const tbody = document.getElementById('projectsTable');
        tbody.innerHTML = '';
        
        accessibleProjects.forEach(project => {
            const manager = allMembers.find(m => String(m.email) === String(project.manager));
            const tr = document.createElement('tr');
            
            tr.innerHTML = `
                <td><strong>${escapeHtml(project.name || '-')}</strong></td>
                <td>${escapeHtml(project.description || '-')}</td>
                <td>${project.startDate || '-'} à ${project.endDate || '-'}</td>
                <td>${escapeHtml(manager ? manager.name : (project.manager || '-'))}</td>
                <td>
                    ${currentUser.role === 'Administrateur' || currentUser.role === 'Responsable Projet' ? 
                        `<button class="btn btn-sm btn-warning me-1" onclick="editProject('${project.id}')">
                            <i class="bi bi-pencil"></i>
                         </button>
                         <button class="btn btn-sm btn-danger" onclick="deleteProject('${project.id}')">
                            <i class="bi bi-trash"></i>
                         </button>` :
                        `<button class="btn btn-sm btn-info">
                            <i class="bi bi-eye"></i>
                         </button>`
                    }
                </td>
            `;
            tbody.appendChild(tr);
        });

        const managerSelect = document.getElementById('projectManager');
        managerSelect.innerHTML = '<option value="">Sélectionner un membre</option>';
        allMembers.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.email;
            opt.textContent = m.name;
            managerSelect.appendChild(opt);
        });
    }

    async function loadTasks() {
        const accessibleTasks = getAccessibleTasks();
        const tasksList = document.getElementById('tasksList');
        const projectFilter = document.getElementById('projectFilter');

        projectFilter.innerHTML = '<option value="">Tous les projets</option>';
        accessibleProjects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            projectFilter.appendChild(opt);
        });

        function renderFiltered() {
            const pid = projectFilter.value;
            const status = document.getElementById('statusFilter').value;
            let filtered = accessibleTasks.slice();
            
            if (pid) filtered = filtered.filter(t => String(t.projectId) === String(pid));
            if (status) filtered = filtered.filter(t => t.status === status);

            tasksList.innerHTML = '';
            
            if (filtered.length === 0) {
                tasksList.innerHTML = '<p class="text-muted">Aucune tâche trouvée</p>';
                return;
            }

            filtered.forEach(task => {
                const project = allProjects.find(p => String(p.id) === String(task.projectId));
                const assignee = allMembers.find(m => String(m.email) === String(task.assignee));
                const canEdit = currentUser.role === 'Administrateur' || 
                               (currentUser.role === 'Responsable Projet' && 
                                accessibleProjects.find(p => String(p.id) === String(task.projectId)));

                tasksList.innerHTML += `
                    <div class="task-card">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="flex: 1;">
                                <h6 style="margin: 0 0 6px 0;">${escapeHtml(task.name)}</h6>
                                <small class="text-muted">${escapeHtml(project ? project.name : 'Projet')}</small><br>
                                ${task.description ? `<small>Description: ${escapeHtml(task.description)}</small><br>` : ''}
                                <small>Assigné à: ${escapeHtml(assignee ? assignee.name : task.assignee)}</small><br>
                                <small>Dates: ${task.startDate || '-'} au ${task.endDate || '-'}</small>
                            </div>
                            <div>
                                <span class="badge-priority" style="background: ${task.priority === 'Haute' ? '#dc3545' : task.priority === 'Moyenne' ? '#ffc107' : '#28a745'}">
                                    ${task.priority}
                                </span><br>
                                <span class="badge ms-1 mt-1" style="background: ${task.status === 'Terminé' ? '#28a745' : task.status === 'En cours' ? '#007bff' : '#6c757d'}; color: #fff;">
                                    ${task.status}
                                </span>
                            </div>
                        </div>
                        ${canEdit ? `
                        <div class="mt-2">
                            <button class="btn btn-sm btn-warning me-1" onclick="editTask('${task.id}')">
                                <i class="bi bi-pencil"></i> Modifier
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTask('${task.id}')">
                                <i class="bi bi-trash"></i> Supprimer
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
        }

        projectFilter.addEventListener('change', renderFiltered);
        document.getElementById('statusFilter').addEventListener('change', renderFiltered);
        renderFiltered();

        // Remplir les selects du formulaire
        const taskProject = document.getElementById('taskProject');
        taskProject.innerHTML = '<option value="">Sélectionner un projet</option>';
        accessibleProjects.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name;
            taskProject.appendChild(opt);
        });

        const taskAssignee = document.getElementById('taskAssignee');
        taskAssignee.innerHTML = '<option value="">Sélectionner un membre</option>';
        allMembers.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.email;
            opt.textContent = m.name;
            taskAssignee.appendChild(opt);
        });
    }

    async function loadMembers() {
        const membersTable = document.getElementById('membersTable');
        membersTable.innerHTML = '';

        let displayMembers = allMembers;
        if (currentUser.role === 'Responsable Projet') {
            const projectIds = new Set(accessibleProjects.map(p => String(p.id)));
            const memberEmails = new Set(allTasks.filter(t => projectIds.has(String(t.projectId))).map(t => String(t.assignee)));
            displayMembers = allMembers.filter(m => memberEmails.has(String(m.email)));
        }

        displayMembers.forEach(member => {
            const memberTasks = allTasks.filter(t => String(t.assignee) === String(member.email));
            const canEdit = currentUser.role === 'Administrateur';

            membersTable.innerHTML += `
                <tr>
                    <td>${escapeHtml(member.name)}</td>
                    <td>${escapeHtml(member.email)}</td>
                    <td>${escapeHtml(member.role)}</td>
                    <td>${memberTasks.length}</td>
                    <td>
                        ${canEdit ? `
                        <button class="btn btn-sm btn-warning me-1" onclick="editMember('${member.id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMember('${member.id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
    }

    async function loadAdmin() {
        if (!currentUser || currentUser.role !== 'Administrateur') {
            Swal.fire('Accès refusé', 'Vous n\'avez pas accès à cette section', 'error');
            return;
        }

        const usersRes = await api(DATA_API_URL, 'getUsers');
        allUsers = Array.isArray(usersRes) ? usersRes : (usersRes.users || allUsers);

        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';

        allUsers.forEach(u => {
            usersList.innerHTML += `
                <div class="card mb-2">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${escapeHtml(u.email)}</strong><br>
                            <small class="text-muted">${escapeHtml(u.role || '')}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.email}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        document.getElementById('usersCount').textContent = allUsers.length;
        document.getElementById('membersCount').textContent = allMembers.length;
        document.getElementById('projectsCount').textContent = allProjects.length;
        document.getElementById('tasksCount').textContent = allTasks.length;
    }

    /*****************************************************************
     * ACTIONS CRUD
     *****************************************************************/
    document.getElementById('saveProjectBtn').addEventListener('click', saveProject);
    document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
    document.getElementById('saveMemberBtn').addEventListener('click', saveMember);
    document.getElementById('saveUserBtn').addEventListener('click', saveUser);

    async function saveProject() {
        const name = document.getElementById('projectName').value.trim();
        const description = document.getElementById('projectDesc').value.trim();
        const startDate = document.getElementById('projectStart').value;
        const endDate = document.getElementById('projectEnd').value;
        const manager = document.getElementById('projectManager').value;

        if (!name || !startDate || !endDate || !manager) { 
            Swal.fire('Erreur', 'Remplissez tous les champs obligatoires', 'error'); 
            return; 
        }

        try {
            const res = await api(DATA_API_URL, 'addProject', 'GET', { 
                name, 
                description, 
                startDate, 
                endDate, 
                manager 
            });
            
            if (res && res.success) {
                Swal.fire('Succès', 'Projet créé avec succès', 'success');
                bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
                document.getElementById('projectForm').reset();
                await loadAllData();
                showView('projects');
            } else {
                Swal.fire('Erreur', res.error || 'Erreur lors de la création du projet', 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function saveTask() {
        const name = document.getElementById('taskName').value.trim();
        const description = document.getElementById('taskDescription').value.trim();
        const projectId = document.getElementById('taskProject').value;
        const assignee = document.getElementById('taskAssignee').value;
        const status = document.getElementById('taskStatus').value;
        const priority = document.getElementById('taskPriority').value;
        const startDate = document.getElementById('taskStart').value;
        const endDate = document.getElementById('taskEnd').value;

        if (!name || !projectId || !assignee || !startDate || !endDate) { 
            Swal.fire('Erreur', 'Remplissez tous les champs obligatoires', 'error'); 
            return; 
        }

        try {
            const res = await api(DATA_API_URL, 'addTask', 'GET', { 
                name, 
                description, 
                projectId, 
                assignee, 
                status, 
                priority, 
                startDate, 
                endDate 
            });
            
            if (res && res.success) {
                Swal.fire('Succès', 'Tâche créée avec succès', 'success');
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                document.getElementById('taskForm').reset();
                await loadAllData();
                showView('tasks');
            } else {
                Swal.fire('Erreur', res.error || 'Erreur lors de la création de la tâche', 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function saveMember() {
        const name = document.getElementById('memberName').value.trim();
        const email = document.getElementById('memberEmail').value.trim();
        const role = document.getElementById('memberRole').value;

        if (!name || !email || !role) { 
            Swal.fire('Erreur', 'Remplissez tous les champs', 'error'); 
            return; 
        }

        try {
            const res = await api(DATA_API_URL, 'addMember', 'GET', { 
                name, 
                email, 
                role 
            });
            
            if (res && res.success) {
                Swal.fire('Succès', 'Membre ajouté avec succès', 'success');
                bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
                document.getElementById('memberForm').reset();
                await loadAllData();
                showView('members');
            } else {
                Swal.fire('Erreur', res.error || 'Erreur lors de l\'ajout du membre', 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function saveUser() {
        const email = document.getElementById('userName').value.trim();
        const code = document.getElementById('userCode').value.trim();
        const role = document.getElementById('userRole').value;

        if (!email || !code || !role) { 
            Swal.fire('Erreur', 'Remplissez tous les champs', 'error'); 
            return; 
        }

        try {
            const res = await api(DATA_API_URL, 'addUser', 'GET', { 
                email, 
                code, 
                role 
            });
            
            if (res && res.success) {
                Swal.fire('Succès', 'Utilisateur créé avec succès', 'success');
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                document.getElementById('userForm').reset();
                await loadAdmin();
            } else {
                Swal.fire('Erreur', res.error || 'Erreur lors de la création de l\'utilisateur', 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', 'Erreur: ' + (err.message || err), 'error');
        }
    }

    async function deleteProject(projectId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api(DATA_API_URL, 'deleteProject', 'GET', { id: projectId });
        if (res && res.success) { await loadAllData(); showView('projects'); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    async function deleteTask(taskId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api(DATA_API_URL, 'deleteTask', 'GET', { id: taskId });
        if (res && res.success) { await loadAllData(); showView('tasks'); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    async function deleteMember(memberId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api(DATA_API_URL, 'deleteMember', 'GET', { id: memberId });
        if (res && res.success) { await loadAllData(); showView('members'); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    async function deleteUser(email) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api(DATA_API_URL, 'deleteUser', 'GET', { email });
        if (res && res.success) { await loadAdmin(); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    function editProject(projectId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }
    function editTask(taskId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }
    function editMember(memberId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }

    /*****************************************************************
     * INITIALISATION
     *****************************************************************/
    window.addEventListener('load', async () => {
        const saved = localStorage.getItem('currentUser');
        if (saved) {
            try { 
                currentUser = JSON.parse(saved); 
                showApp(); 
                await loadAllData(); 
            } catch (e) { 
                console.warn('session parse error', e); 
                localStorage.removeItem('currentUser'); 
            }
        }
    });

    /*****************************************************************
     * UTILITAIRES
     *****************************************************************/
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
    </script>
</body>
</html>
