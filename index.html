<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion de Projets - Google Sheets</title>

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Simplified + cleaned styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
        }
        .login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
        .login-box {
            width:100%; max-width:420px; background:#fff; border-radius:12px; padding:32px;
            box-shadow:0 10px 40px rgba(0,0,0,0.25);
        }
        .btn-login { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); border:none; color:#fff; }
        .app-container { display:none; min-height:100vh; }
        .sidebar {
            position:fixed; left:0; top:0; width:250px; min-height:100vh;
            background: linear-gradient(180deg,#667eea 0%,#764ba2 100%); color:#fff; padding:20px 10px; overflow:auto;
        }
        .main-content { margin-left:250px; padding:30px; }
        .view-section { display:none; }
        .view-section.active { display:block; }
        .task-card { background:#fff; border-left:4px solid #667eea; padding:12px; border-radius:8px; margin-bottom:12px; }
        .badge-priority { font-size:0.85rem; padding:5px 8px; border-radius:6px; color:#fff; }
        .loading { display:none; text-align:center; padding:20px; }
        .loading.active { display:block; }
        @media (max-width:768px) {
            .sidebar { width:200px; }
            .main-content { margin-left:200px; padding:18px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2><i class="bi bi-shield-lock"></i> Authentification</h2>
            <p>Connectez-vous à votre espace de gestion de projets</p>

            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input id="email" type="email" class="form-control" placeholder="votre@email.com" required>
                </div>
                <div class="mb-3">
                    <label for="code" class="form-label">Code d'accès</label>
                    <input id="code" type="password" class="form-control" placeholder="Entrez votre code" required>
                </div>
                <button type="submit" class="btn btn-login w-100">
                    <i class="bi bi-box-arrow-in-right"></i> Se connecter
                </button>
            </form>

            <div class="setup-info mt-3 p-3" style="background:#f0f4ff;border-left:4px solid #667eea;">
                <strong>Identifiants de test:</strong>
                <p style="margin:8px 0 0 0;">Email: <code>admin@example.com</code><br>Code: <code>1234</code></p>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div id="appContainer" class="app-container">
        <div class="sidebar">
            <div class="sidebar-header text-center mb-3">
                <h3>GestioProj</h3>
                <p style="opacity:0.9; margin:0;">Gestion de Projets</p>
            </div>
            <nav class="nav flex-column">
                <a class="nav-link active text-white" href="#" data-view="dashboard"><i class="bi bi-speedometer2"></i> Tableau de bord</a>
                <a class="nav-link text-white" href="#" data-view="projects"><i class="bi bi-folder"></i> Projets</a>
                <a class="nav-link text-white" href="#" data-view="tasks"><i class="bi bi-list-task"></i> Tâches</a>
                <a class="nav-link text-white" href="#" data-view="members"><i class="bi bi-people"></i> Membres</a>
                <a class="nav-link text-white" href="#" data-view="admin"><i class="bi bi-gear"></i> Administration</a>
                <hr style="opacity:0.3;">
                <a class="nav-link text-white" href="#" id="logoutBtn"><i class="bi bi-box-arrow-left"></i> Déconnexion</a>
            </nav>
        </div>

        <div class="main-content">
            <div class="header-bar bg-white p-3 rounded mb-3 d-flex justify-content-between align-items-center" style="box-shadow:0 2px 10px rgba(0,0,0,0.08);">
                <h1 id="viewTitle" style="color:#667eea; font-size:1.5rem; margin:0;">Tableau de bord</h1>
                <div class="user-info text-end" style="color:#666;">
                    <p style="margin:0;"><strong id="userName">Utilisateur</strong></p>
                    <p id="userRole" style="margin:0;">Rôle</p>
                </div>
            </div>

            <div id="loading" class="loading">
                <div class="spinner-border" role="status"><span class="visually-hidden">Chargement...</span></div>
                <p class="mt-2">Chargement des données...</p>
            </div>

            <!-- DASHBOARD -->
            <div id="dashboard" class="view-section active">
                <div class="row mb-3">
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="projectCount" style="color:#667eea;">0</h3>
                            <p>Projets accessibles</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="taskCount" style="color:#764ba2;">0</h3>
                            <p>Tâches assignées</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="completedCount" style="color:#28a745;">0</h3>
                            <p>Tâches terminées</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-2">
                        <div class="card p-3 text-center">
                            <h3 id="lateCount" style="color:#dc3545;">0</h3>
                            <p>Tâches en retard</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-gradient" style="background:linear-gradient(135deg,#667eea,#764ba2); color:#fff;">
                        <h5 class="mb-0">Tâches récentes</h5>
                    </div>
                    <div class="card-body">
                        <div id="recentTasks"></div>
                    </div>
                </div>
            </div>

            <!-- PROJECTS -->
            <div id="projects" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Projets</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projectModal">
                        <i class="bi bi-plus-circle"></i> Nouveau projet
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Description</th>
                                    <th>Dates</th>
                                    <th>Responsable</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TASKS -->
            <div id="tasks" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Tâches</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal">
                        <i class="bi bi-plus-circle"></i> Nouvelle tâche
                    </button>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4 mb-2">
                        <select id="projectFilter" class="form-select"><option value="">Tous les projets</option></select>
                    </div>
                    <div class="col-md-4 mb-2">
                        <select id="statusFilter" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option>À faire</option>
                            <option>En cours</option>
                            <option>Terminé</option>
                        </select>
                    </div>
                </div>

                <div id="tasksList"></div>
            </div>

            <!-- MEMBERS -->
            <div id="members" class="view-section">
                <div class="d-flex justify-content-between mb-3">
                    <h2>Gestion des Membres</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#memberModal">
                        <i class="bi bi-plus-circle"></i> Nouveau membre
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Projets</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="membersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ADMIN -->
            <div id="admin" class="view-section">
                <h2>Administration</h2>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">Gestion des utilisateurs</div>
                            <div class="card-body">
                                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#userModal">
                                    <i class="bi bi-person-plus"></i> Ajouter un utilisateur
                                </button>
                                <div id="usersList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">Informations système</div>
                            <div class="card-body">
                                <p><strong>Utilisateurs:</strong> <span id="usersCount">0</span></p>
                                <p><strong>Membres:</strong> <span id="membersCount">0</span></p>
                                <p><strong>Projets:</strong> <span id="projectsCount">0</span></p>
                                <p><strong>Tâches:</strong> <span id="tasksCount">0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- main-content -->
    </div> <!-- appContainer -->

    <!-- Modals (project, task, member, user) -->
    <!-- Project Modal -->
    <div class="modal fade" id="projectModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau projet</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="projectForm">
                <div class="mb-3"><label class="form-label">Nom du projet *</label><input id="projectName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea id="projectDesc" class="form-control" rows="3"></textarea></div>
                <div class="mb-3"><label class="form-label">Date de début *</label><input id="projectStart" type="date" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Date de fin *</label><input id="projectEnd" type="date" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Responsable *</label><select id="projectManager" class="form-select" required><option value="">Sélectionner un membre</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveProjectBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouvelle tâche</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="mb-3"><label class="form-label">Nom de la tâche *</label><input id="taskName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Description</label><textarea id="taskDescription" class="form-control" rows="3"></textarea></div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Projet *</label><select id="taskProject" class="form-select" required><option value="">Sélectionner un projet</option></select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Assigné à *</label><select id="taskAssignee" class="form-select" required><option value="">Sélectionner un membre</option></select></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Date de début *</label><input id="taskStart" type="date" class="form-control" required></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Date de fin *</label><input id="taskEnd" type="date" class="form-control" required></div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Statut</label><select id="taskStatus" class="form-select"><option>À faire</option><option>En cours</option><option>Terminé</option></select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Priorité</label><select id="taskPriority" class="form-select"><option>Basse</option><option selected>Moyenne</option><option>Haute</option></select></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveTaskBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- Member Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Nouveau membre</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="memberForm">
                <div class="mb-3"><label class="form-label">Nom *</label><input id="memberName" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Email *</label><input id="memberEmail" type="email" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Rôle *</label><select id="memberRole" class="form-select" required><option value="">Sélectionner</option><option>Développeur</option><option>Designer</option><option>Manager</option><option>QA</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveMemberBtn">Enregistrer</button></div>
    </div></div></div>

    <!-- User Modal (admin) -->
    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Ajouter un utilisateur système</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="userForm">
                <div class="mb-3"><label class="form-label">Email *</label><input id="userName" type="email" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Code d'accès *</label><input id="userCode" class="form-control" required></div>
                <div class="mb-3"><label class="form-label">Rôle *</label><select id="userRole" class="form-select" required><option>Utilisateur</option><option>Responsable Projet</option><option>Administrateur</option></select></div>
            </form>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button><button class="btn btn-primary" id="saveUserBtn">Enregistrer</button></div>
    </div></div></div>

    <script>
    /*****************************************************************
     * CONFIG
     *****************************************************************/
    const API_URL = 'https://script.google.com/macros/s/AKfycbzeRKk1pTyDY1C9JfDUTa5Aew59wH6KPfDMkL9tNqbkMNZw7Pkw7S5vC-WttCqOzXRf/exec';
    const SPREADSHEET_ID = '1SYZgSXW-UzjQGC-YEdKgkV2xI7WoOFow4vHm4TjJQSw';

    /*****************************************************************
     * STATE
     *****************************************************************/
    let currentUser = null;
    let allProjects = [];
    let allTasks = [];
    let allMembers = [];
    let allUsers = [];
    let accessibleProjects = [];

    /*****************************************************************
     * UTILS: central fetch helper for API actions
     *
     * Usage:
     *   api('getProjects')                     -> GET
     *   api('addProject','POST', {name:...})   -> POST JSON
     *****************************************************************/
    async function api(action, method = 'GET', body = null) {
        try {
            let url = API_URL + '?action=' + encodeURIComponent(action);
            const options = { method, headers: {} };

            if (method.toUpperCase() === 'GET' && body && typeof body === 'object') {
                // append simple query params for GET
                url += '&' + Object.keys(body).map(k => `${encodeURIComponent(k)}=${encodeURIComponent(body[k])}`).join('&');
            } else if (method.toUpperCase() === 'POST') {
                options.headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body || {});
            }

            const resp = await fetch(url, options);

            // try parse JSON even if status not 200 (server returns JSON for errors too)
            const text = await resp.text();
            try {
                return JSON.parse(text);
            } catch (err) {
                // fallback
                return { success: false, error: 'Réponse non JSON: ' + text };
            }
        } catch (error) {
            return { success: false, error: error.message || String(error) };
        }
    }

    /*****************************************************************
     * LOGIN
     *****************************************************************/
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const code = document.getElementById('code').value.trim();

        if (!email || !code) {
            Swal.fire('Erreur', 'Remplissez email et code', 'error');
            return;
        }

        try {
            showLoading(true);
            // authenticate via GET query params (the Apps Script authenticate expects query parameters)
            const result = await api('authenticate', 'GET', { email, code });

            if (result && result.success) {
                currentUser = result.user;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showApp();
                await loadAllData();
            } else {
                Swal.fire('Erreur', 'Email ou code incorrect', 'error');
                console.error('Auth failed:', result);
            }
        } catch (error) {
            console.error('Erreur login:', error);
            Swal.fire('Erreur', 'Impossible de se connecter: ' + (error.message || error), 'error');
        } finally {
            showLoading(false);
        }
    });

    /*****************************************************************
     * APP UI helpers
     *****************************************************************/
    function showApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        updateUserInfo();
        setupNavigation();
        checkAdminAccess();
    }

    function updateUserInfo() {
        if (!currentUser) return;
        const name = (currentUser.email || '').split('@')[0] || 'Utilisateur';
        document.getElementById('userName').textContent = name;
        document.getElementById('userRole').textContent = currentUser.role || '';
    }

    function checkAdminAccess() {
        const adminLink = document.querySelector('[data-view="admin"]');
        if (!currentUser || currentUser.role !== 'Administrateur') {
            adminLink.style.display = 'none';
        } else {
            adminLink.style.display = '';
        }
    }

    function setupNavigation() {
        document.querySelectorAll('[data-view]').forEach(link => {
            link.addEventListener('click', (ev) => {
                ev.preventDefault();
                const view = link.getAttribute('data-view');
                // admins can always view admin; others blocked by checkAdminAccess earlier
                showView(view);
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', (ev) => {
            ev.preventDefault();
            logout();
        });
    }

    function showView(viewName) {
        document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
        const viewEl = document.getElementById(viewName);
        if (!viewEl) return;
        viewEl.classList.add('active');

        document.querySelectorAll('[data-view]').forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[data-view="${viewName}"]`);
        if (activeLink) activeLink.classList.add('active');

        const titles = { dashboard: 'Tableau de bord', projects: 'Gestion des Projets', tasks: 'Gestion des Tâches', members: 'Gestion des Membres', admin: 'Administration' };
        document.getElementById('viewTitle').textContent = titles[viewName] || 'Vue';

        // lazy load data if needed
        if (viewName === 'dashboard') loadDashboard();
        if (viewName === 'projects') loadProjects();
        if (viewName === 'tasks') loadTasks();
        if (viewName === 'members') loadMembers();
        if (viewName === 'admin') loadAdmin();
    }

    function showLoading(show) {
        document.getElementById('loading').classList.toggle('active', !!show);
    }

    function logout() {
        localStorage.removeItem('currentUser');
        currentUser = null;
        location.reload();
    }

    /*****************************************************************
     * DATA LOADING
     *****************************************************************/
    async function loadAllData() {
        showLoading(true);
        try {
            // fetch in parallel (getProjects, getTasks, getMembers, getUsers)
            const [pRes, tRes, mRes, uRes] = await Promise.all([
                api('getProjects'),
                api('getTasks'),
                api('getMembers'),
                api('getUsers')
            ]);

            allProjects = Array.isArray(pRes) ? pRes : (pRes.projects || []);
            allTasks = Array.isArray(tRes) ? tRes : (tRes.tasks || []);
            allMembers = Array.isArray(mRes) ? mRes : (mRes.members || []);
            allUsers = Array.isArray(uRes) ? uRes : (uRes.users || []);

            // ensure arrays
            allProjects = allProjects || [];
            allTasks = allTasks || [];
            allMembers = allMembers || [];
            allUsers = allUsers || [];

            determineAccessibleProjects();
            await loadDashboard();
        } catch (error) {
            console.error('Erreur loadAllData:', error);
            Swal.fire('Erreur', 'Erreur lors du chargement des données: ' + (error.message || error), 'error');
        } finally {
            showLoading(false);
        }
    }

    function determineAccessibleProjects() {
        if (!currentUser) { accessibleProjects = []; return; }
        if (currentUser.role === 'Administrateur') {
            accessibleProjects = [...allProjects];
            return;
        }
        if (currentUser.role === 'Responsable Projet') {
            accessibleProjects = allProjects.filter(p => String(p.manager) === String(currentUser.email));
            return;
        }
        // simple user: projects where they have tasks assigned
        const projectIds = new Set(allTasks.filter(t => String(t.assignee) === String(currentUser.email)).map(t => String(t.projectId)));
        accessibleProjects = allProjects.filter(p => projectIds.has(String(p.id)));
    }

    function getAccessibleTasks() {
        if (!currentUser) return [];
        if (currentUser.role === 'Administrateur') return allTasks;
        if (currentUser.role === 'Responsable Projet') {
            const ids = new Set(accessibleProjects.map(p => String(p.id)));
            return allTasks.filter(t => ids.has(String(t.projectId)));
        }
        return allTasks.filter(t => String(t.assignee) === String(currentUser.email));
    }

    /*****************************************************************
     * RENDERERS: Dashboard / Projects / Tasks / Members / Admin
     *****************************************************************/
    async function loadDashboard() {
        const accessibleTasks = getAccessibleTasks();
        document.getElementById('projectCount').textContent = accessibleProjects.length;
        document.getElementById('taskCount').textContent = accessibleTasks.filter(t => String(t.assignee) === String(currentUser.email)).length;
        document.getElementById('completedCount').textContent = accessibleTasks.filter(t => t.status === 'Terminé' && String(t.assignee) === String(currentUser.email)).length;

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('lateCount').textContent = accessibleTasks.filter(t => (t.endDate || '') < today && t.status !== 'Terminé' && String(t.assignee) === String(currentUser.email)).length;

        const recentTasksContainer = document.getElementById('recentTasks');
        recentTasksContainer.innerHTML = '';

        const recentTasks = accessibleTasks
            .filter(t => String(t.assignee) === String(currentUser.email))
            .sort((a, b) => new Date(b.endDate || 0) - new Date(a.endDate || 0))
            .slice(0, 5);

        if (recentTasks.length === 0) {
            const p = document.createElement('p'); p.className = 'text-muted'; p.textContent = 'Aucune tâche assignée';
            recentTasksContainer.appendChild(p);
            return;
        }

        recentTasks.forEach(task => {
            const project = allProjects.find(p => String(p.id) === String(task.projectId));
            const wrapper = document.createElement('div');
            wrapper.className = 'task-card';

            const left = document.createElement('div');
            left.style.flex = '1';
            const h6 = document.createElement('h6');
            h6.style.margin = '0 0 6px 0';
            h6.textContent = task.name || 'Tâche';
            const smallProj = document.createElement('small');
            smallProj.className = 'text-muted';
            smallProj.textContent = project ? project.name : 'Projet';
            const br = document.createElement('br');

            const desc = document.createElement('small');
            if (task.description) {
                desc.textContent = (task.description.length > 60) ? (task.description.substring(0, 60) + '...') : task.description;
                desc.style.display = 'block';
            }
            const dates = document.createElement('small');
            dates.textContent = `Dates: ${task.startDate || '-'} au ${task.endDate || '-'}`;

            left.appendChild(h6);
            left.appendChild(smallProj);
            left.appendChild(br);
            if (task.description) left.appendChild(desc);
            left.appendChild(dates);

            const badges = document.createElement('div');
            badges.style.marginLeft = '12px';
            const pri = document.createElement('span'); pri.className = 'badge-priority';
            pri.style.background = task.priority === 'Haute' ? '#dc3545' : task.priority === 'Moyenne' ? '#ffc107' : '#28a745';
            pri.textContent = task.priority || 'Moyenne';
            const st = document.createElement('span'); st.className = 'badge ms-1';
            st.style.background = task.status === 'Terminé' ? '#28a745' : task.status === 'En cours' ? '#007bff' : '#6c757d';
            st.style.color = '#fff';
            st.textContent = task.status || 'À faire';

            badges.appendChild(pri);
            badges.appendChild(st);

            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.justifyContent = 'space-between';
            container.style.alignItems = 'start';
            container.appendChild(left);
            container.appendChild(badges);

            wrapper.appendChild(container);
            recentTasksContainer.appendChild(wrapper);
        });
    }

    async function loadProjects() {
        const tbody = document.getElementById('projectsTable');
        tbody.innerHTML = '';
        accessibleProjects.forEach(project => {
            const tr = document.createElement('tr');
            const tdName = document.createElement('td'); tdName.innerHTML = `<strong>${escapeHtml(project.name || '-')}</strong>`;
            const tdDesc = document.createElement('td'); tdDesc.textContent = project.description || '-';
            const tdDates = document.createElement('td'); tdDates.textContent = `${project.startDate || '-'} à ${project.endDate || '-'}`;
            const manager = allMembers.find(m => String(m.email) === String(project.manager));
            const tdManager = document.createElement('td'); tdManager.textContent = manager ? manager.name : (project.manager || '-');

            const tdActions = document.createElement('td');
            if (currentUser.role === 'Administrateur' || currentUser.role === 'Responsable Projet') {
                const editBtn = document.createElement('button'); editBtn.className = 'btn btn-sm btn-warning me-1'; editBtn.innerHTML = '<i class="bi bi-pencil"></i>'; editBtn.onclick = () => editProject(project.id);
                const delBtn = document.createElement('button'); delBtn.className = 'btn btn-sm btn-danger'; delBtn.innerHTML = '<i class="bi bi-trash"></i>'; delBtn.onclick = () => deleteProject(project.id);
                tdActions.appendChild(editBtn); tdActions.appendChild(delBtn);
            } else {
                const viewBtn = document.createElement('button'); viewBtn.className = 'btn btn-sm btn-info'; viewBtn.innerHTML = '<i class="bi bi-eye"></i>';
                tdActions.appendChild(viewBtn);
            }

            tr.appendChild(tdName); tr.appendChild(tdDesc); tr.appendChild(tdDates); tr.appendChild(tdManager); tr.appendChild(tdActions);
            tbody.appendChild(tr);
        });

        // fill managers select
        const managerSelect = document.getElementById('projectManager');
        managerSelect.innerHTML = '<option value="">Sélectionner un membre</option>';
        allMembers.forEach(m => {
            const opt = document.createElement('option'); opt.value = m.email; opt.textContent = m.name; managerSelect.appendChild(opt);
        });
    }

    async function loadTasks() {
        const accessibleTasks = getAccessibleTasks();
        const tasksList = document.getElementById('tasksList');
        const projectFilter = document.getElementById('projectFilter');
        const statusFilter = document.getElementById('statusFilter');

        projectFilter.innerHTML = '<option value="">Tous les projets</option>';
        accessibleProjects.forEach(p => { const o = document.createElement('option'); o.value = p.id; o.textContent = p.name; projectFilter.appendChild(o); });

        function renderFiltered() {
            const pid = projectFilter.value;
            const status = statusFilter.value;
            let filtered = accessibleTasks.slice();
            if (pid) filtered = filtered.filter(t => String(t.projectId) === String(pid));
            if (status) filtered = filtered.filter(t => t.status === status);

            tasksList.innerHTML = '';
            if (filtered.length === 0) {
                const p = document.createElement('p'); p.className = 'text-muted'; p.textContent = 'Aucune tâche trouvée';
                tasksList.appendChild(p); return;
            }

            filtered.forEach(task => {
                const project = allProjects.find(p => String(p.id) === String(task.projectId));
                const assignee = allMembers.find(m => String(m.email) === String(task.assignee));

                const card = document.createElement('div'); card.className = 'task-card';
                const container = document.createElement('div'); container.style.display = 'flex'; container.style.justifyContent ='space-between';

                const left = document.createElement('div'); left.style.flex='1';
                const title = document.createElement('h6'); title.style.margin='0 0 6px 0'; title.textContent = task.name;
                const proj = document.createElement('small'); proj.className='text-muted'; proj.textContent = project ? project.name : 'Projet';
                const desc = document.createElement('small'); if (task.description) { desc.textContent = 'Description: ' + task.description; desc.style.display='block'; }
                const ass = document.createElement('small'); ass.textContent = 'Assigné à: ' + (assignee ? assignee.name : task.assignee);
                const dates = document.createElement('small'); dates.textContent = `Dates: ${task.startDate || '-'} au ${task.endDate || '-'}`;

                left.appendChild(title); left.appendChild(proj); left.appendChild(document.createElement('br'));
                if (task.description) left.appendChild(desc);
                left.appendChild(ass); left.appendChild(document.createElement('br')); left.appendChild(dates);

                const right = document.createElement('div');
                const pri = document.createElement('span'); pri.className='badge-priority'; pri.style.background = task.priority === 'Haute' ? '#dc3545' : task.priority === 'Moyenne' ? '#ffc107' : '#28a745'; pri.textContent = task.priority;
                const st = document.createElement('span'); st.className='badge ms-1'; st.style.background = task.status === 'Terminé' ? '#28a745' : task.status === 'En cours' ? '#007bff' : '#6c757d'; st.style.color = '#fff'; st.textContent = task.status;

                right.appendChild(pri); right.appendChild(document.createElement('br')); right.appendChild(st);

                container.appendChild(left); container.appendChild(right);
                card.appendChild(container);

                // actions for admins / project managers on project they manage
                if (currentUser.role === 'Administrateur' || (currentUser.role === 'Responsable Projet' && accessibleProjects.find(p => String(p.id) === String(task.projectId)))) {
                    const actionsDiv = document.createElement('div'); actionsDiv.className = 'mt-2';
                    const editBtn = document.createElement('button'); editBtn.className='btn btn-sm btn-warning me-1'; editBtn.innerHTML='<i class="bi bi-pencil"></i> Modifier'; editBtn.onclick = () => editTask(task.id);
                    const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-danger'; delBtn.innerHTML='<i class="bi bi-trash"></i> Supprimer'; delBtn.onclick = () => deleteTask(task.id);
                    actionsDiv.appendChild(editBtn); actionsDiv.appendChild(delBtn); card.appendChild(actionsDiv);
                }

                tasksList.appendChild(card);
            });
        }

        projectFilter.addEventListener('change', renderFiltered);
        statusFilter.addEventListener('change', renderFiltered);
        renderFiltered();

        // fill task form selects
        const taskProject = document.getElementById('taskProject'); taskProject.innerHTML = '<option value="">Sélectionner un projet</option>';
        accessibleProjects.forEach(p => { const opt = document.createElement('option'); opt.value = p.id; opt.textContent = p.name; taskProject.appendChild(opt); });

        const taskAssignee = document.getElementById('taskAssignee'); taskAssignee.innerHTML = '<option value="">Sélectionner un membre</option>';
        allMembers.forEach(m => { const opt = document.createElement('option'); opt.value = m.email; opt.textContent = m.name; taskAssignee.appendChild(opt); });
    }

    async function loadMembers() {
        const membersTable = document.getElementById('membersTable');
        membersTable.innerHTML = '';

        let displayMembers = allMembers;
        if (currentUser.role === 'Responsable Projet') {
            const projectIds = new Set(accessibleProjects.map(p => String(p.id)));
            const memberEmails = new Set(allTasks.filter(t => projectIds.has(String(t.projectId))).map(t => String(t.assignee)));
            displayMembers = allMembers.filter(m => memberEmails.has(String(m.email)));
        }

        displayMembers.forEach(member => {
            const memberTasks = allTasks.filter(t => String(t.assignee) === String(member.email));
            const tr = document.createElement('tr');
            const tdName = document.createElement('td'); tdName.textContent = member.name;
            const tdEmail = document.createElement('td'); tdEmail.textContent = member.email;
            const tdRole = document.createElement('td'); tdRole.textContent = member.role;
            const tdProjects = document.createElement('td'); tdProjects.textContent = memberTasks.length;
            const tdActions = document.createElement('td');
            if (currentUser.role === 'Administrateur') {
                const editBtn = document.createElement('button'); editBtn.className='btn btn-sm btn-warning me-1'; editBtn.innerHTML='<i class="bi bi-pencil"></i>'; editBtn.onclick = () => editMember(member.id);
                const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-danger'; delBtn.innerHTML='<i class="bi bi-trash"></i>'; delBtn.onclick = () => deleteMember(member.id);
                tdActions.appendChild(editBtn); tdActions.appendChild(delBtn);
            }
            tr.appendChild(tdName); tr.appendChild(tdEmail); tr.appendChild(tdRole); tr.appendChild(tdProjects); tr.appendChild(tdActions);
            membersTable.appendChild(tr);
        });
    }

    async function loadAdmin() {
        if (!currentUser || currentUser.role !== 'Administrateur') {
            Swal.fire('Accès refusé', 'Vous n\'avez pas accès à cette section', 'error');
            return;
        }
        // ensure users are up-to-date
        const usersRes = await api('getUsers');
        allUsers = Array.isArray(usersRes) ? usersRes : (usersRes.users || allUsers);

        const usersList = document.getElementById('usersList'); usersList.innerHTML = '';
        allUsers.forEach(u => {
            const div = document.createElement('div'); div.className='card mb-2';
            const body = document.createElement('div'); body.className='card-body d-flex justify-content-between align-items-center';
            const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(u.email)}</strong><br><small class="text-muted">${escapeHtml(u.role || '')}</small>`;
            const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-danger'; delBtn.innerHTML='<i class="bi bi-trash"></i>'; delBtn.onclick = () => deleteUser(u.email);
            body.appendChild(left); body.appendChild(delBtn); div.appendChild(body); usersList.appendChild(div);
        });

        document.getElementById('usersCount').textContent = allUsers.length;
        document.getElementById('membersCount').textContent = allMembers.length;
        document.getElementById('projectsCount').textContent = allProjects.length;
        document.getElementById('tasksCount').textContent = allTasks.length;
    }

    /*****************************************************************
     * ACTIONS: saveProject, saveTask, saveMember, saveUser, delete...
     *****************************************************************/
    document.getElementById('saveProjectBtn').addEventListener('click', saveProject);
    document.getElementById('saveTaskBtn').addEventListener('click', saveTask);
    document.getElementById('saveMemberBtn').addEventListener('click', saveMember);
    document.getElementById('saveUserBtn').addEventListener('click', saveUser);

    async function saveProject() {
        const name = document.getElementById('projectName').value.trim();
        const desc = document.getElementById('projectDesc').value.trim();
        const start = document.getElementById('projectStart').value;
        const end = document.getElementById('projectEnd').value;
        const manager = document.getElementById('projectManager').value;

        if (!name || !start || !end || !manager) { Swal.fire('Erreur', 'Remplissez tous les champs obligatoires', 'error'); return; }

        try {
            const res = await api('addProject', 'POST', { name, desc, start, end, manager });
            if (res && res.success) {
                Swal.fire('Succès', 'Projet créé', 'success');
                bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
                document.getElementById('projectForm').reset();
                await loadAllData();
                showView('projects');
            } else {
                Swal.fire('Erreur', 'Impossible de créer le projet: ' + (res.error || 'Erreur serveur'), 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', err.message || err, 'error');
        }
    }

    async function saveTask() {
        const name = document.getElementById('taskName').value.trim();
        const description = document.getElementById('taskDescription').value.trim();
        const projectId = document.getElementById('taskProject').value;
        const assignee = document.getElementById('taskAssignee').value;
        const status = document.getElementById('taskStatus').value;
        const priority = document.getElementById('taskPriority').value;
        const startDate = document.getElementById('taskStart').value;
        const endDate = document.getElementById('taskEnd').value;

        if (!name || !projectId || !assignee || !startDate || !endDate) { Swal.fire('Erreur', 'Remplissez tous les champs obligatoires', 'error'); return; }
        if (new Date(startDate) > new Date(endDate)) { Swal.fire('Erreur', 'La date de début doit être avant la date de fin', 'error'); return; }

        try {
            const res = await api('addTask', 'POST', { name, description, projectId, assignee, status, priority, startDate, endDate });
            if (res && res.success) {
                Swal.fire('Succès', 'Tâche créée', 'success');
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                document.getElementById('taskForm').reset();
                await loadAllData();
                showView('tasks');
            } else {
                Swal.fire('Erreur', 'Impossible de créer la tâche: ' + (res.error || 'Erreur serveur'), 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', err.message || err, 'error');
        }
    }

    async function saveMember() {
        const name = document.getElementById('memberName').value.trim();
        const email = document.getElementById('memberEmail').value.trim();
        const role = document.getElementById('memberRole').value;

        if (!name || !email || !role) { Swal.fire('Erreur', 'Remplissez tous les champs', 'error'); return; }

        try {
            const res = await api('addMember', 'POST', { name, email, role });
            if (res && res.success) {
                Swal.fire('Succès', 'Membre créé', 'success');
                bootstrap.Modal.getInstance(document.getElementById('memberModal')).hide();
                document.getElementById('memberForm').reset();
                await loadAllData();
                showView('members');
            } else {
                Swal.fire('Erreur', 'Impossible de créer le membre: ' + (res.error || 'Erreur serveur'), 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', err.message || err, 'error');
        }
    }

    async function saveUser() {
        const email = document.getElementById('userName').value.trim();
        const code = document.getElementById('userCode').value.trim();
        const role = document.getElementById('userRole').value;

        if (!email || !code) { Swal.fire('Erreur', 'Remplissez tous les champs', 'error'); return; }

        try {
            const res = await api('addUser', 'POST', { email, code, role });
            if (res && res.success) {
                Swal.fire('Succès', 'Utilisateur créé', 'success');
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                document.getElementById('userForm').reset();
                await loadAdmin();
            } else {
                Swal.fire('Erreur', 'Impossible de créer l\'utilisateur: ' + (res.error || 'Erreur serveur'), 'error');
            }
        } catch (err) {
            Swal.fire('Erreur', err.message || err, 'error');
        }
    }

    async function deleteProject(projectId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api('deleteProject', 'GET', { id: projectId });
        if (res && res.success) { await loadAllData(); showView('projects'); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    async function deleteTask(taskId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api('deleteTask', 'GET', { id: taskId });
        if (res && res.success) { await loadAllData(); showView('tasks'); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    async function deleteMember(memberId) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api('deleteMember', 'GET', { id: memberId });
        if (res && res.success) { await loadAllData(); showView('members'); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    async function deleteUser(email) {
        const confirmed = await Swal.fire({ title:'Confirmer', text:'Êtes-vous sûr?', icon:'warning', showCancelButton:true, confirmButtonText:'Oui' });
        if (!confirmed.isConfirmed) return;
        const res = await api('deleteUser', 'GET', { email });
        if (res && res.success) { await loadAdmin(); } else Swal.fire('Erreur', res.error || 'Impossible de supprimer');
    }

    function editProject(projectId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }
    function editTask(taskId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }
    function editMember(memberId) { Swal.fire('Info', 'Modification en cours de développement', 'info'); }

    /*****************************************************************
     * INIT: restore session if present
     *****************************************************************/
    window.addEventListener('load', async () => {
        const saved = localStorage.getItem('currentUser');
        if (saved) {
            try { currentUser = JSON.parse(saved); showApp(); await loadAllData(); }
            catch (e) { console.warn('session parse error', e); localStorage.removeItem('currentUser'); }
        }
    });

    /*****************************************************************
     * Small helpers
     *****************************************************************/
    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/[&<>"'`=\/]/g, function(s) {
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;',"/":'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];
        });
    }
    </script>
</body>
</html>
